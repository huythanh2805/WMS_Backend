// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AccessLevel {
  OWNER
  MEMBER
  VIEWER
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  COMPLETED
  IN_REVIEW
  BACKLOG
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum FileType {
  PDF
  IMAGE
  DOCUMENT
  VIDEO
  OTHER
}

enum SubscriptionPlan {
  FREE
  PRO
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
}

// ────────────────────────────────────────────────

model User {
  id                     String               @id @default(uuid())
  name                   String
  email                  String               @unique
  password               String?
  refreshToken           String?
  about                  String?
  industryType           String?
  roleType               String?
  country                String?
  image                  String?
  workspaces             WorkspaceMember[]
  tasks                  Task[]               // tasks được assign cho user
  activities             Activity[]
  comments               Comment[]
  subscription           Subscription?
  onboardingCompleted    Boolean?             @default(false)
  createdAt              DateTime             @default(now())
  updatedAt              DateTime             @updatedAt
}

// ────────────────────────────────────────────────

model Workspace {
  id              String            @id @default(uuid())
  name            String
  description     String?
  ownerId         String
  inviteCode      String            @unique
  inviteAt        DateTime?         @default(now())
  members         WorkspaceMember[]
  projects        Project[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@unique([ownerId]) // optional, nếu bạn muốn enforce 1 workspace chỉ có 1 owner rõ ràng
}

// ────────────────────────────────────────────────

model WorkspaceMember {
  id                String              @id @default(uuid())
  userId            String
  workspaceId       String
  accessLevel       AccessLevel         @default(MEMBER)
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  workspace         Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  projectAccess     ProjectAccess[]     // quyền truy cập project cụ thể
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@unique([userId, workspaceId])
}

// ────────────────────────────────────────────────

model Project {
  id                String              @id @default(uuid())
  name              String
  description       String?
  workspaceId       String
  workspace         Workspace           @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  tasks             Task[]
  files             File[]
  projectAccess     ProjectAccess[]
  documentation     Documentation[]
  comments          Comment[]
  activities        Activity[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  @@unique([workspaceId, name]) // tránh trùng tên project trong cùng workspace
}

// ────────────────────────────────────────────────

model ProjectAccess {
  id                    String           @id @default(uuid())
  workspaceMemberId     String
  projectId             String
  workspaceMember       WorkspaceMember  @relation(fields: [workspaceMemberId], references: [id], onDelete: Cascade)
  project               Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  accessLevel           AccessLevel      @default(VIEWER)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt

  @@unique([workspaceMemberId, projectId])
}

// ────────────────────────────────────────────────

model Task {
  id            String       @id @default(uuid())
  title         String
  description   String?
  status        TaskStatus   @default(TODO)
  priority      TaskPriority @default(LOW)
  startDate     DateTime?
  dueDate       DateTime?
  position      Int          // để drag & drop sắp xếp
  projectId     String
  assigneeId    String?
  project       Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  assignedTo    User?        @relation(fields: [assigneeId], references: [id], onDelete: SetNull)
  attachments   File[]
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

// ────────────────────────────────────────────────

model File {
  id          String     @id @default(uuid())
  name        String
  url         String
  taskId      String?
  projectId   String?
  type        FileType
  task        Task?      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  project     Project?   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  createdAt   DateTime   @default(now())
}

// ────────────────────────────────────────────────

model Comment {
  id          String   @id @default(uuid())
  content     String
  projectId   String
  userId      String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([userId])
}

// ────────────────────────────────────────────────

model Activity {
  id          String   @id @default(cuid())
  type        String
  description String
  projectId   String
  userId      String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@index([projectId])
  @@index([userId])
}

// ────────────────────────────────────────────────

model Documentation {
  id          String   @id @default(uuid())
  content     String
  projectId   String   @unique
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ────────────────────────────────────────────────

model Subscription {
  id                      String               @id @default(uuid())
  userId                  String               @unique
  user                    User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan                    SubscriptionPlan     @default(FREE)
  status                  SubscriptionStatus   @default(ACTIVE)
  lemonsqueezyId          String?              // Lemon Squeezy subscription ID
  orderId                 String?              // Lemon Squeezy order ID
  customerId              String?              // Lemon Squeezy customer ID
  frequency               String               @default("monthly")
  cancelAtPeriodEnd       Boolean              @default(false)
  currentPeriodEnd        DateTime?
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt

  @@index([userId])
}